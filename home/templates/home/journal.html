{% extends 'home/base.html' %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">{{ page_title }}</h1>
    
    <!-- Add Journal Entry Form -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Add Journal Entry</h5>
        </div>
        <div class="card-body">
            <form id="journalForm">
                <div class="mb-3">
                    <label for="title" class="form-label">Title</label>
                    <input type="text" class="form-control" id="title" required>
                </div>
                <div class="mb-3">
                    <label for="content" class="form-label">Content</label>
                    <textarea class="form-control" id="content" rows="4" required></textarea>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="date" class="form-label">Date</label>
                        <input type="date" class="form-control" id="date" value="{{ today_date }}">
                    </div>
                    <div class="col-md-6">
                        <label for="mood" class="form-label">Mood</label>
                        <select class="form-control" id="mood">
                            <option value="">Select mood (optional)</option>
                            <option value="Great">Great</option>
                            <option value="Good">Good</option>
                            <option value="Neutral">Neutral</option>
                            <option value="Tired">Tired</option>
                            <option value="Sore">Sore</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Save Entry</button>
            </form>
        </div>
    </div>
    
    <!-- Journal Stats -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">Journal Stats</h5>
        </div>
        <div class="card-body" id="journalStats">
            <div class="d-flex justify-content-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Journal Entries List -->
    <div class="card">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">Journal Entries</h5>
        </div>
        <div class="card-body">
            <div id="journalEntries">
                <div class="d-flex justify-content-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Journal Entry Modal -->
<div class="modal fade" id="journalModal" tabindex="-1" aria-labelledby="journalModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="journalModalLabel">Edit Journal Entry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editJournalForm">
                    <input type="hidden" id="editEntryId">
                    <div class="mb-3">
                        <label for="editTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="editTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="editContent" class="form-label">Content</label>
                        <textarea class="form-control" id="editContent" rows="4" required></textarea>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="editDate">
                        </div>
                        <div class="col-md-6">
                            <label for="editMood" class="form-label">Mood</label>
                            <select class="form-control" id="editMood">
                                <option value="">Select mood (optional)</option>
                                <option value="Great">Great</option>
                                <option value="Good">Good</option>
                                <option value="Neutral">Neutral</option>
                                <option value="Tired">Tired</option>
                                <option value="Sore">Sore</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger me-auto" id="deleteEntryBtn">Delete</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveEntryBtn">Save changes</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Set default date to today
        document.getElementById('date').valueAsDate = new Date();
        
        // Load journal entries
        loadJournalEntries();
        
        // Load journal stats
        loadJournalStats();
        
        // Handle form submission
        document.getElementById('journalForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            const date = document.getElementById('date').value;
            const mood = document.getElementById('mood').value;
            
            fetch('/journal-api/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    title: title,
                    content: content,
                    date: date,
                    mood: mood
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Clear form
                    document.getElementById('title').value = '';
                    document.getElementById('content').value = '';
                    document.getElementById('mood').value = '';
                    
                    // Reload entries and stats
                    loadJournalEntries();
                    loadJournalStats();
                    
                    // Show success message
                    alert('Journal entry added successfully!');
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while saving the journal entry.');
            });
        });
        
        // Handle edit form submission
        document.getElementById('saveEntryBtn').addEventListener('click', function() {
            const entryId = document.getElementById('editEntryId').value;
            const title = document.getElementById('editTitle').value;
            const content = document.getElementById('editContent').value;
            const date = document.getElementById('editDate').value;
            const mood = document.getElementById('editMood').value;
            
            fetch(`/journal-api/${entryId}/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    title: title,
                    content: content,
                    date: date,
                    mood: mood
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('journalModal'));
                    modal.hide();
                    
                    // Reload entries and stats
                    loadJournalEntries();
                    loadJournalStats();
                    
                    // Show success message
                    alert('Journal entry updated successfully!');
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating the journal entry.');
            });
        });
        
        // Handle delete button
        document.getElementById('deleteEntryBtn').addEventListener('click', function() {
            if (confirm('Are you sure you want to delete this journal entry?')) {
                const entryId = document.getElementById('editEntryId').value;
                
                fetch(`/journal-api/${entryId}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Close modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('journalModal'));
                        modal.hide();
                        
                        // Reload entries and stats
                        loadJournalEntries();
                        loadJournalStats();
                        
                        // Show success message
                        alert('Journal entry deleted successfully!');
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the journal entry.');
                });
            }
        });
    });
    
    function loadJournalEntries() {
        const entriesContainer = document.getElementById('journalEntries');
        entriesContainer.innerHTML = `
            <div class="d-flex justify-content-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        `;
        
        fetch('/journal-api/')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.entries.length === 0) {
                        entriesContainer.innerHTML = '<p class="text-center">No journal entries yet. Add your first entry above!</p>';
                        return;
                    }
                    
                    let entriesHtml = '';
                    data.entries.forEach(entry => {
                        const date = new Date(entry.date);
                        const formattedDate = date.toLocaleDateString();
                        
                        let moodBadge = '';
                        if (entry.mood) {
                            let badgeClass = 'bg-secondary';
                            if (entry.mood === 'Great') badgeClass = 'bg-success';
                            if (entry.mood === 'Good') badgeClass = 'bg-info';
                            if (entry.mood === 'Neutral') badgeClass = 'bg-secondary';
                            if (entry.mood === 'Tired') badgeClass = 'bg-warning';
                            if (entry.mood === 'Sore') badgeClass = 'bg-danger';
                            
                            moodBadge = `<span class="badge ${badgeClass} ms-2">${entry.mood}</span>`;
                        }
                        
                        entriesHtml += `
                            <div class="card mb-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">${entry.title} ${moodBadge}</h5>
                                    <small class="text-muted">${formattedDate}</small>
                                </div>
                                <div class="card-body">
                                    <p class="card-text">${entry.content}</p>
                                    <button class="btn btn-sm btn-outline-primary edit-entry" data-entry-id="${entry.id}">Edit</button>
                                </div>
                            </div>
                        `;
                    });
                    
                    entriesContainer.innerHTML = entriesHtml;
                    
                    // Add event listeners to edit buttons
                    document.querySelectorAll('.edit-entry').forEach(button => {
                        button.addEventListener('click', function() {
                            const entryId = this.getAttribute('data-entry-id');
                            const entry = data.entries.find(e => e.id == entryId);
                            
                            document.getElementById('editEntryId').value = entry.id;
                            document.getElementById('editTitle').value = entry.title;
                            document.getElementById('editContent').value = entry.content;
                            document.getElementById('editDate').value = entry.date;
                            document.getElementById('editMood').value = entry.mood || '';
                            
                            const modal = new bootstrap.Modal(document.getElementById('journalModal'));
                            modal.show();
                        });
                    });
                } else {
                    entriesContainer.innerHTML = `<p class="text-center text-danger">Error loading entries: ${data.error}</p>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                entriesContainer.innerHTML = '<p class="text-center text-danger">An error occurred while loading journal entries.</p>';
            });
    }
    
    function loadJournalStats() {
        const statsContainer = document.getElementById('journalStats');
        statsContainer.innerHTML = `
            <div class="d-flex justify-content-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        `;
        
        fetch('/journal-api/stats/')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const stats = data.stats;
                    
                    // Create mood distribution chart data
                    const moodLabels = Object.keys(stats.mood_counts);
                    const moodData = Object.values(stats.mood_counts);
                    
                    // Create entries by month chart data
                    const monthLabels = Object.keys(stats.entries_by_month);
                    const monthData = Object.values(stats.entries_by_month);
                    
                    let statsHtml = `
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">Total Entries</h5>
                                        <h2 class="display-4">${stats.total_entries}</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">Current Streak</h5>
                                        <h2 class="display-4">${stats.current_streak} day${stats.current_streak !== 1 ? 's' : ''}</h2>
                                        <p class="text-muted mb-0">Longest: ${stats.longest_streak} day${stats.longest_streak !== 1 ? 's' : ''}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    statsContainer.innerHTML = statsHtml;
                } else {
                    statsContainer.innerHTML = `<p class="text-center text-danger">Error loading stats: ${data.error}</p>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                statsContainer.innerHTML = '<p class="text-center text-danger">An error occurred while loading journal stats.</p>';
            });
    }
    
    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}