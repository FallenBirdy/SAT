{% extends 'home/base.html' %}

{% block title %}Workout Calendar{% endblock %}

{% block page_title %}Workout Calendar{% endblock %}

{% block extra_css %}
<style>
  .calendar-container {
    background-color: var(--bg-primary, #ffffff);
    border-radius: 10px;
    box-shadow: var(--shadow-light, 0 2px 10px rgba(0, 0, 0, 0.1));
  }
  
  .calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid var(--border-color, #e3e6f0);
  }
  
  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
    padding: 15px;
  }
  
  .calendar-day-header {
    text-align: center;
    font-weight: bold;
    padding: 10px 0;
  }
  
  .calendar-day {
    min-height: 100px;
    border: 1px solid var(--border-color, #e3e6f0);
    border-radius: 4px;
    padding: 5px;
    position: relative;
  }
  
  .calendar-day.today {
    background-color: rgba(102, 126, 234, 0.1);
    border: 1px solid rgba(102, 126, 234, 0.5);
  }
  
  .calendar-day.other-month {
    background-color: var(--bg-tertiary, #e3e6f0);
    color: var(--text-muted, #858796);
  }
  
  .day-number {
    font-size: 14px;
    font-weight: bold;
    margin-bottom: 5px;
  }
  
  .workout-item {
    font-size: 12px;
    padding: 3px 6px;
    margin-bottom: 3px;
    border-radius: 3px;
    cursor: pointer;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .workout-planned {
    background-color: #ffeeba;
    border-left: 3px solid #ffc107;
  }
  
  .workout-completed {
    background-color: #c3e6cb;
    border-left: 3px solid #28a745;
  }
  
  .workout-missed {
    background-color: #f5c6cb;
    border-left: 3px solid #dc3545;
  }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
  <div class="col-md-9">
    <div class="card">
      <div class="card-body p-0">
        <div class="calendar-container">
          <div class="calendar-header">
            <button id="prevMonth" class="btn btn-sm btn-outline-primary">
              <i class="fas fa-chevron-left"></i> Previous
            </button>
            <h4 id="currentMonthYear" class="mb-0">August 2023</h4>
            <button id="nextMonth" class="btn btn-sm btn-outline-primary">
              Next <i class="fas fa-chevron-right"></i>
            </button>
          </div>
          <div class="calendar-grid">
            <div class="calendar-day-header">Sun</div>
            <div class="calendar-day-header">Mon</div>
            <div class="calendar-day-header">Tue</div>
            <div class="calendar-day-header">Wed</div>
            <div class="calendar-day-header">Thu</div>
            <div class="calendar-day-header">Fri</div>
            <div class="calendar-day-header">Sat</div>
            <!-- Calendar days will be generated by JavaScript -->
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-md-3">
    <div class="card mb-3">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Schedule Workout</h5>
      </div>
      <div class="card-body">
        <form id="scheduleWorkoutForm">
          <div class="mb-3">
            <label for="workoutTitle" class="form-label">Title</label>
            <input type="text" class="form-control" id="workoutTitle" required>
          </div>
          <div class="mb-3">
            <label for="workoutDate" class="form-label">Date</label>
            <input type="date" class="form-control" id="workoutDate" required>
          </div>
          <div class="mb-3">
            <label for="workoutDescription" class="form-label">Description (optional)</label>
            <textarea class="form-control" id="workoutDescription" rows="2"></textarea>
          </div>
          <button type="submit" class="btn btn-primary w-100">Schedule Workout</button>
        </form>
      </div>
    </div>
    
    <div class="card">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Upcoming Workouts</h5>
      </div>
      <div class="card-body">
        <ul class="list-group" id="upcomingWorkouts">
          <!-- Upcoming workouts will be added here -->
          <li class="list-group-item text-center">No upcoming workouts</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Workout Details Modal -->
<div class="modal fade" id="workoutDetailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="workoutModalTitle">Workout Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <strong>Date:</strong> <span id="modalWorkoutDate"></span>
        </div>
        <div class="mb-3">
          <strong>Title:</strong> <span id="modalWorkoutTitle"></span>
        </div>
        <div class="mb-3">
          <strong>Description:</strong> <p id="modalWorkoutDescription"></p>
        </div>
        <div class="mb-3">
          <strong>Status:</strong> <span id="modalWorkoutStatus" class="badge"></span>
        </div>
        <div class="mb-3">
          <strong>Notes:</strong>
          <textarea class="form-control" id="modalWorkoutNotes" rows="3"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" id="markCompletedBtn">Mark as Completed</button>
        <button type="button" class="btn btn-danger" id="markMissedBtn">Mark as Missed</button>
        <button type="button" class="btn btn-warning" id="markPlannedBtn">Mark as Planned</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Success Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
  <div id="calendarSuccessToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header bg-success text-white">
      <strong class="me-auto">Success</strong>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="toastMessage">
      Workout scheduled successfully!
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Set today's date as default for scheduling
    const today = new Date();
    const formattedDate = today.toISOString().split('T')[0];
    document.getElementById('workoutDate').value = formattedDate;
    
    // Current date for calendar
    let currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    
    // Store workouts data
    let workouts = [];
    
    // Initialize calendar
    updateCalendar();
    loadWorkouts();
    
    // Event listeners for month navigation
    document.getElementById('prevMonth').addEventListener('click', function() {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      updateCalendar();
    });
    
    document.getElementById('nextMonth').addEventListener('click', function() {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      updateCalendar();
    });
    
    // Event listener for scheduling a workout
    document.getElementById('scheduleWorkoutForm').addEventListener('submit', function(e) {
      e.preventDefault();
      scheduleWorkout();
    });
    
    // Event listeners for workout status buttons
    document.getElementById('markCompletedBtn').addEventListener('click', function() {
      updateWorkoutStatus('completed');
    });
    
    document.getElementById('markMissedBtn').addEventListener('click', function() {
      updateWorkoutStatus('missed');
    });
    
    document.getElementById('markPlannedBtn').addEventListener('click', function() {
      updateWorkoutStatus('planned');
    });
    
    function updateCalendar() {
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      
      // Update header
      document.getElementById('currentMonthYear').textContent = `${monthNames[currentMonth]} ${currentYear}`;
      
      // Get first day of month and number of days
      const firstDay = new Date(currentYear, currentMonth, 1).getDay();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      
      // Get days from previous month
      const daysInPrevMonth = new Date(currentYear, currentMonth, 0).getDate();
      
      // Clear existing calendar days
      const calendarGrid = document.querySelector('.calendar-grid');
      const dayHeaders = calendarGrid.querySelectorAll('.calendar-day-header');
      
      // Remove all elements except day headers
      while (calendarGrid.childElementCount > 7) {
        calendarGrid.removeChild(calendarGrid.lastChild);
      }
      
      // Add days from previous month
      for (let i = 0; i < firstDay; i++) {
        const prevMonthDay = daysInPrevMonth - firstDay + i + 1;
        const dayElement = createDayElement(prevMonthDay, true);
        calendarGrid.appendChild(dayElement);
      }
      
      // Add days from current month
      for (let i = 1; i <= daysInMonth; i++) {
        const isToday = i === today.getDate() && 
                        currentMonth === today.getMonth() && 
                        currentYear === today.getFullYear();
        
        const dayElement = createDayElement(i, false, isToday);
        calendarGrid.appendChild(dayElement);
        
        // Add date attribute for workout lookup
        const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
        dayElement.setAttribute('data-date', dateStr);
      }
      
      // Add days from next month
      const totalDaysAdded = firstDay + daysInMonth;
      const remainingCells = 42 - totalDaysAdded; // 6 rows of 7 days
      
      for (let i = 1; i <= remainingCells; i++) {
        const dayElement = createDayElement(i, true);
        calendarGrid.appendChild(dayElement);
      }
      
      // Add workouts to calendar
      addWorkoutsToCalendar();
    }
    
    function createDayElement(dayNumber, isOtherMonth, isToday = false) {
      const dayElement = document.createElement('div');
      dayElement.className = 'calendar-day';
      
      if (isOtherMonth) {
        dayElement.classList.add('other-month');
      }
      
      if (isToday) {
        dayElement.classList.add('today');
      }
      
      const dayNumberElement = document.createElement('div');
      dayNumberElement.className = 'day-number';
      dayNumberElement.textContent = dayNumber;
      
      dayElement.appendChild(dayNumberElement);
      return dayElement;
    }
    
    function loadWorkouts() {
      fetch('/scheduled-workout-api/')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            workouts = data.workouts;
            addWorkoutsToCalendar();
            updateUpcomingWorkouts();
          }
        })
        .catch(error => {
          console.error('Error loading workouts:', error);
          // Show fallback message if API endpoint doesn't exist yet
          document.getElementById('upcomingWorkouts').innerHTML = 
            '<li class="list-group-item text-center">Failed to load workouts</li>';
        });
    }
    
    function addWorkoutsToCalendar() {
      // Clear existing workout items
      document.querySelectorAll('.workout-item').forEach(item => item.remove());
      
      // Add workouts to calendar days
      workouts.forEach(workout => {
        const workoutDate = new Date(workout.date);
        const workoutMonth = workoutDate.getMonth();
        const workoutYear = workoutDate.getFullYear();
        
        // Only add workouts for the current month and year being displayed
        if (workoutMonth === currentMonth && workoutYear === currentYear) {
          const dayElement = document.querySelector(`[data-date="${workout.date}"]`);
          
          if (dayElement) {
            const workoutElement = document.createElement('div');
            workoutElement.className = `workout-item workout-${workout.status}`;
            workoutElement.textContent = workout.title;
            workoutElement.setAttribute('data-workout-id', workout.id);
            
            workoutElement.addEventListener('click', function() {
              showWorkoutDetails(workout);
            });
            
            dayElement.appendChild(workoutElement);
          }
        }
      });
    }
    
    function updateUpcomingWorkouts() {
      const upcomingContainer = document.getElementById('upcomingWorkouts');
      upcomingContainer.innerHTML = '';
      
      // Filter for upcoming workouts (today and future, planned status)
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const upcoming = workouts.filter(workout => {
        const workoutDate = new Date(workout.date);
        workoutDate.setHours(0, 0, 0, 0);
        return workoutDate >= today && workout.status === 'planned';
      });
      
      // Sort by date (closest first)
      upcoming.sort((a, b) => new Date(a.date) - new Date(b.date));
      
      // Limit to next 5 workouts
      const nextWorkouts = upcoming.slice(0, 5);
      
      if (nextWorkouts.length === 0) {
        upcomingContainer.innerHTML = '<li class="list-group-item text-center">No upcoming workouts</li>';
        return;
      }
      
      nextWorkouts.forEach(workout => {
        const workoutDate = new Date(workout.date);
        const formattedDate = workoutDate.toLocaleDateString();
        
        const listItem = document.createElement('li');
        listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
        listItem.innerHTML = `
          <div>
            <strong>${workout.title}</strong>
            <br>
            <small>${formattedDate}</small>
          </div>
          <span class="badge bg-warning rounded-pill">Planned</span>
        `;
        
        listItem.addEventListener('click', function() {
          showWorkoutDetails(workout);
        });
        
        upcomingContainer.appendChild(listItem);
      });
    }
    
    function scheduleWorkout() {
      const title = document.getElementById('workoutTitle').value;
      const date = document.getElementById('workoutDate').value;
      const description = document.getElementById('workoutDescription').value;
      
      fetch('/scheduled-workout-api/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
          title: title,
          date: date,
          description: description,
          status: 'planned'
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Add new workout to the list
          workouts.push(data.workout);
          
          // Update calendar and upcoming workouts
          addWorkoutsToCalendar();
          updateUpcomingWorkouts();
          
          // Reset form
          document.getElementById('workoutTitle').value = '';
          document.getElementById('workoutDescription').value = '';
          
          // Show success toast
          const toast = new bootstrap.Toast(document.getElementById('calendarSuccessToast'));
          document.getElementById('toastMessage').textContent = 'Workout scheduled successfully!';
          toast.show();
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(error => console.error('Error scheduling workout:', error));
    }
    
    function showWorkoutDetails(workout) {
      // Set modal content
      document.getElementById('modalWorkoutTitle').textContent = workout.title;
      document.getElementById('modalWorkoutDate').textContent = new Date(workout.date).toLocaleDateString();
      document.getElementById('modalWorkoutDescription').textContent = workout.description || 'No description';
      
      const statusBadge = document.getElementById('modalWorkoutStatus');
      statusBadge.textContent = workout.status.charAt(0).toUpperCase() + workout.status.slice(1);
      
      // Set badge color based on status
      statusBadge.className = 'badge';
      if (workout.status === 'planned') {
        statusBadge.classList.add('bg-warning');
      } else if (workout.status === 'completed') {
        statusBadge.classList.add('bg-success');
      } else if (workout.status === 'missed') {
        statusBadge.classList.add('bg-danger');
      }
      
      document.getElementById('modalWorkoutNotes').value = workout.notes || '';
      
      // Store workout ID in modal for status updates
      document.getElementById('workoutDetailsModal').setAttribute('data-workout-id', workout.id);
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('workoutDetailsModal'));
      modal.show();
    }
    
    function updateWorkoutStatus(status) {
      const modal = document.getElementById('workoutDetailsModal');
      const workoutId = modal.getAttribute('data-workout-id');
      const notes = document.getElementById('modalWorkoutNotes').value;
      
      fetch(`/scheduled-workout-api/${workoutId}/`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
          workout_id: workoutId,
          status: status,
          notes: notes
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Update workout in local array
          const workoutIndex = workouts.findIndex(w => w.id == workoutId);
          if (workoutIndex !== -1) {
            workouts[workoutIndex].status = status;
            workouts[workoutIndex].notes = notes;
          }
          
          // Update calendar and upcoming workouts
          addWorkoutsToCalendar();
          updateUpcomingWorkouts();
          
          // Hide modal
          bootstrap.Modal.getInstance(modal).hide();
          
          // Show success toast
          const toast = new bootstrap.Toast(document.getElementById('calendarSuccessToast'));
          document.getElementById('toastMessage').textContent = `Workout marked as ${status}!`;
          toast.show();
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(error => console.error('Error updating workout status:', error));
    }
  });
</script>
{% endblock %}