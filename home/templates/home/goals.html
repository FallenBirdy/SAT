{% extends 'home/base.html' %}

{% block title %}Goals | Fitness Tracker{% endblock %}

{% block page_title %}Fitness Goals{% endblock %}

{% block content %}

  <div class="row">
    <div class="col-lg-6">
      <!-- Goal Setting Card -->
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="fas fa-bullseye me-2"></i>Set New Goal</h5>
        </div>
        <div class="card-body">
          <form id="goalForm">
            <div class="mb-3">
              <label for="goalTitle" class="form-label">Goal Title</label>
              <input type="text" class="form-control" id="goalTitle" placeholder="e.g. Run 5km without stopping, Lose 10 pounds, Bench press bodyweight">
            </div>
            <div class="mb-3">
              <label for="goalDetails" class="form-label">Goal Details</label>
              <textarea class="form-control" id="goalDetails" rows="3" placeholder="e.g. Complete by end of month, train 3 times per week, track progress weekly"></textarea>
            </div>
            <div class="mb-3">
              <label for="goalTarget" class="form-label">Target Date (Optional)</label>
              <input type="date" class="form-control" id="goalTarget">
            </div>
            <button type="button" class="btn btn-primary" onclick="setGoal()">
              <i class="fas fa-plus-circle me-2"></i>Save Goal
            </button>
          </form>
        </div>
      </div>
    </div>
    
    <div class="col-lg-6">
      <!-- Goals List Card -->
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="fas fa-list-check me-2"></i>My Goals</h5>
        </div>
        <div class="card-body">
          <div id="goalList" class="list-group">
            {% if goals %}
              {% for goal in goals %}
                <div class="list-group-item list-group-item-action">
                  <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1" style="font-weight: 700; font-size: 1.2rem; letter-spacing: 0.2px; line-height: 1.3;">{{ goal.title }}</h5>
                    {% if goal.target_date %}
                      <small class="text-muted">Target: {{ goal.target_date }}</small>
                    {% endif %}
                  </div>
                  <p class="mb-1">{{ goal.details }}</p>
                  <div class="d-flex justify-content-between align-items-center mt-2">
                    <div class="progress flex-grow-1 me-2" style="height: 10px;">
                      <div class="progress-bar bg-success" role="progressbar" style="width: {{ goal.progress|default:0 }}%;" 
                           aria-valuenow="{{ goal.progress|default:0 }}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <span class="badge bg-primary">{{ goal.progress|default:0 }}%</span>
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <p class="text-center text-muted my-4">No goals set yet. Start by creating your first fitness goal!</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Weight Progress Chart Section -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Weight Progress</h5>
          <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#logWeightModal">
            <i class="fas fa-weight me-1"></i>Log Weight
          </button>
        </div>
        <div class="card-body">
          <canvas id="weightChart" height="300"></canvas>
          <p class="text-center text-muted mt-3" id="noWeightData">No weight data available. Start tracking your progress!</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Weight Logging Modal -->
  <div class="modal fade" id="logWeightModal" tabindex="-1" aria-labelledby="logWeightModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="logWeightModalLabel">Log Your Weight</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="weightForm">
            <div class="mb-3">
              <label for="weightValue" class="form-label">Weight</label>
              <div class="input-group">
                <input type="number" step="0.1" class="form-control" id="weightValue" placeholder="Enter current weight (lbs or kg)">
                <span class="input-group-text">kg</span>
              </div>
            </div>
            <div class="mb-3">
              <label for="weightDate" class="form-label">Date</label>
              <input type="date" class="form-control" id="weightDate">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="logWeight()">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header bg-success text-white">
        <i class="fas fa-check-circle me-2"></i>
        <strong class="me-auto">Success</strong>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="toastMessage">
        Item saved successfully!
      </div>
    </div>
  </div>

  <script>
    // Initialize weight chart
    let weightChart;
    const weightData = [];
    const weightLabels = [];
    
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize the chart
      const ctx = document.getElementById('weightChart').getContext('2d');
      weightChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: weightLabels,
          datasets: [{
            label: 'Weight (kg)',
            data: weightData,
            backgroundColor: 'rgba(102, 126, 234, 0.2)',
            borderColor: 'rgba(102, 126, 234, 1)',
            borderWidth: 2,
            fill: false,
            pointBackgroundColor: 'rgba(102, 126, 234, 1)',
            pointRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: false,
              title: {
                display: true,
                text: 'Weight (kg)'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Date'
              }
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'top'
            },
            tooltip: {
              callbacks: {
                title: function(tooltipItems) {
                  return tooltipItems[0].label;
                },
                label: function(context) {
                  return `Weight: ${context.raw} kg`;
                }
              }
            }
          }
        }
      });
      
      // Set today's date as default for weight logging
      document.getElementById('weightDate').valueAsDate = new Date();
      
      // Hide chart if no data
      updateChartVisibility();
      
      // Load weight data if available
      loadWeightData();
    });
    
    function updateChartVisibility() {
      const noDataMessage = document.getElementById('noWeightData');
      if (weightData.length > 0) {
        noDataMessage.style.display = 'none';
      } else {
        noDataMessage.style.display = 'block';
      }
    }
    
    function loadWeightData() {
      // This would normally fetch from an API
      // For now, we'll just check if there's data in the user's profile
      // and update the chart accordingly
    }
    
    function logWeight() {
      const weightValue = document.getElementById('weightValue').value;
      const weightDate = document.getElementById('weightDate').value;
      
      if (!weightValue || !weightDate) {
        alert('Please enter both your current weight and the date to track your progress.');
        return;
      }
      
      // Get CSRF token from base.html function
      const csrftoken = getCSRFToken();
      
      // Send data to server (we'll need to create this API endpoint)
      fetch('/log-weight/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
          weight: weightValue,
          date: weightDate
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Add new weight to the chart
          addWeightToChart(weightDate, parseFloat(weightValue));
          
          // Clear form and close modal
          document.getElementById('weightValue').value = '';
          const weightModal = bootstrap.Modal.getInstance(document.getElementById('logWeightModal'));
          weightModal.hide();
          
          // Show success toast
          const toast = new bootstrap.Toast(document.getElementById('successToast'));
          document.getElementById('toastMessage').textContent = 'Weight logged successfully!';
          toast.show();
        } else {
          alert('Error saving weight: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error saving weight');
      });
    }
    
    function addWeightToChart(date, weight) {
      // Format date for display
      const formattedDate = new Date(date).toLocaleDateString();
      
      // Add to chart data
      weightLabels.push(formattedDate);
      weightData.push(weight);
      
      // Update chart
      weightChart.update();
      updateChartVisibility();
    }
    
    function setGoal() {
      const title = document.getElementById('goalTitle').value;
      const details = document.getElementById('goalDetails').value;
      const targetDate = document.getElementById('goalTarget').value;
      
      if (!title) {
        alert('Please enter a title for your fitness goal.');
        return;
      }
      
      // Get CSRF token from base.html function
      const csrftoken = getCSRFToken();
      
      // Send data to server
      fetch('/log-goal/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
          title: title,
          details: details,
          target_date: targetDate
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Add new goal to the list
          const goalList = document.getElementById('goalList');
          
          // Remove "no goals" message if it exists
          const noGoalsMsg = goalList.querySelector('.text-center.text-muted');
          if (noGoalsMsg) {
            noGoalsMsg.remove();
          }
          
          // Create new goal item
          const goalItem = document.createElement('div');
          goalItem.className = 'list-group-item list-group-item-action';
          
          // Format target date if provided
          let targetDateDisplay = '';
          if (targetDate) {
            const formattedDate = new Date(targetDate).toLocaleDateString();
            targetDateDisplay = `<small class="text-muted">Target: ${formattedDate}</small>`;
          }
          
          goalItem.innerHTML = `
            <div class="d-flex w-100 justify-content-between">
              <h5 class="mb-1">${title}</h5>
              ${targetDateDisplay}
            </div>
            <p class="mb-1">${details}</p>
            <div class="d-flex justify-content-between align-items-center mt-2">
              <div class="progress flex-grow-1 me-2" style="height: 10px;">
                <div class="progress-bar bg-success" role="progressbar" style="width: 0%;" 
                     aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <span class="badge bg-primary">0%</span>
            </div>
          `;
          
          goalList.prepend(goalItem);
          
          // Clear form
          document.getElementById('goalTitle').value = '';
          document.getElementById('goalDetails').value = '';
          document.getElementById('goalTarget').value = '';
          
          // Show success toast
          const toast = new bootstrap.Toast(document.getElementById('successToast'));
          document.getElementById('toastMessage').textContent = 'Goal saved successfully!';
          toast.show();
        } else {
          alert('Error saving goal: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error saving goal');
      });
    }
    
    // CSRF helper for Django
    function getCSRFToken() {
      const name = 'csrftoken';
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        let [key, val] = cookie.trim().split('=');
        if (key === name) return val;
      }
      return '';
    }
  </script>
{% endblock %}