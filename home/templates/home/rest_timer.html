{% extends 'home/base.html' %}

{% block title %}Rest Timer - Fitness Tracker{% endblock %}

{% block page_title %}Rest Timer{% endblock %}

{% block extra_css %}
<style>
  .timer-display {
    font-size: 4rem;
    font-weight: bold;
    text-align: center;
    margin: 1rem 0;
  }
  
  .timer-controls {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-bottom: 2rem;
  }
  
  .timer-presets {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }
  
  .timer-preset {
    flex: 1;
    min-width: 100px;
  }
  
  .saved-timers {
    margin-top: 2rem;
  }
  
  .timer-card {
    margin-bottom: 1rem;
  }
  
  .timer-actions {
    display: flex;
    gap: 0.5rem;
  }
  
  .notification-settings {
    margin-top: 2rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-8 mx-auto">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Rest Timer</h5>
        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#saveTimerModal">
          <i class="fas fa-save"></i> Save New Timer
        </button>
      </div>
      <div class="card-body">
        <!-- Timer Display -->
        <div class="timer-display" id="timerDisplay">00:00</div>
        
        <!-- Timer Controls -->
        <div class="timer-controls">
          <button id="startTimer" class="btn btn-lg btn-success">
            <i class="fas fa-play"></i> Start
          </button>
          <button id="pauseTimer" class="btn btn-lg btn-warning" disabled>
            <i class="fas fa-pause"></i> Pause
          </button>
          <button id="resetTimer" class="btn btn-lg btn-danger" disabled>
            <i class="fas fa-redo"></i> Reset
          </button>
        </div>
        
        <!-- Quick Presets -->
        <h6>Quick Presets</h6>
        <div class="timer-presets">
          <button class="btn btn-outline-primary timer-preset" data-seconds="30">30s</button>
          <button class="btn btn-outline-primary timer-preset" data-seconds="60">1m</button>
          <button class="btn btn-outline-primary timer-preset" data-seconds="90">1m 30s</button>
          <button class="btn btn-outline-primary timer-preset" data-seconds="120">2m</button>
          <button class="btn btn-outline-primary timer-preset" data-seconds="180">3m</button>
          <button class="btn btn-outline-primary timer-preset" data-seconds="300">5m</button>
        </div>
        
        <!-- Custom Time Input -->
        <div class="input-group mb-3">
          <input type="number" id="minutesInput" class="form-control" placeholder="Minutes" min="0" max="60" value="0">
          <input type="number" id="secondsInput" class="form-control" placeholder="Seconds" min="0" max="59" value="0">
          <button id="setCustomTime" class="btn btn-outline-secondary">
            <i class="fas fa-check"></i> Set
          </button>
        </div>
        
        <!-- Notification Settings -->
        <div class="notification-settings">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="soundNotification" checked>
            <label class="form-check-label" for="soundNotification">Sound Notification</label>
          </div>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="vibrationNotification" checked>
            <label class="form-check-label" for="vibrationNotification">Vibration (if supported)</label>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Saved Timers -->
    <div class="card saved-timers">
      <div class="card-header">
        <h5 class="mb-0">Saved Timers</h5>
      </div>
      <div class="card-body">
        <div id="savedTimersList">
          <!-- Saved timers will be loaded here -->
          <div class="text-center" id="noTimersMessage">
            <p>No saved timers yet. Create one by clicking "Save New Timer".</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Save Timer Modal -->
<div class="modal fade" id="saveTimerModal" tabindex="-1" aria-labelledby="saveTimerModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="saveTimerModalLabel">Save Timer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="timerName" class="form-label">Timer Name</label>
          <input type="text" class="form-control" id="timerName" placeholder="e.g., Bench Press Rest">
        </div>
        <div class="mb-3">
          <label for="timerDuration" class="form-label">Duration (seconds)</label>
          <input type="number" class="form-control" id="timerDuration" min="1" value="60">
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="setAsDefault">
          <label class="form-check-label" for="setAsDefault">Set as default timer</label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveTimerBtn">Save Timer</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Timer Modal -->
<div class="modal fade" id="editTimerModal" tabindex="-1" aria-labelledby="editTimerModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editTimerModalLabel">Edit Timer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editTimerId">
        <div class="mb-3">
          <label for="editTimerName" class="form-label">Timer Name</label>
          <input type="text" class="form-control" id="editTimerName">
        </div>
        <div class="mb-3">
          <label for="editTimerDuration" class="form-label">Duration (seconds)</label>
          <input type="number" class="form-control" id="editTimerDuration" min="1">
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="editSetAsDefault">
          <label class="form-check-label" for="editSetAsDefault">Set as default timer</label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="updateTimerBtn">Update Timer</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Timer Confirmation Modal -->
<div class="modal fade" id="deleteTimerModal" tabindex="-1" aria-labelledby="deleteTimerModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteTimerModalLabel">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="deleteTimerId">
        <p>Are you sure you want to delete this timer? This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Timer variables
  let timerInterval;
  let remainingSeconds = 0;
  let isPaused = true;
  let notificationSound;
  
  // DOM elements
  const timerDisplay = document.getElementById('timerDisplay');
  const startBtn = document.getElementById('startTimer');
  const pauseBtn = document.getElementById('pauseTimer');
  const resetBtn = document.getElementById('resetTimer');
  const minutesInput = document.getElementById('minutesInput');
  const secondsInput = document.getElementById('secondsInput');
  const setCustomTimeBtn = document.getElementById('setCustomTime');
  const soundNotificationCheckbox = document.getElementById('soundNotification');
  const vibrationNotificationCheckbox = document.getElementById('vibrationNotification');
  const savedTimersList = document.getElementById('savedTimersList');
  const noTimersMessage = document.getElementById('noTimersMessage');
  
  // Create notification sound
  function createNotificationSound() {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.type = 'sine';
    oscillator.frequency.value = 800;
    gainNode.gain.value = 0.5;
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    return {
      play: function() {
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 1);
      }
    };
  }
  
  // Format time as MM:SS
  function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }
  
  // Update timer display
  function updateTimerDisplay() {
    timerDisplay.textContent = formatTime(remainingSeconds);
  }
  
  // Start the timer
  function startTimer() {
    if (remainingSeconds <= 0) return;
    
    isPaused = false;
    startBtn.disabled = true;
    pauseBtn.disabled = false;
    resetBtn.disabled = false;
    
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
      remainingSeconds--;
      updateTimerDisplay();
      
      if (remainingSeconds <= 0) {
        clearInterval(timerInterval);
        timerComplete();
      }
    }, 1000);
  }
  
  // Pause the timer
  function pauseTimer() {
    isPaused = true;
    clearInterval(timerInterval);
    startBtn.disabled = false;
    pauseBtn.disabled = true;
  }
  
  // Reset the timer
  function resetTimer() {
    isPaused = true;
    clearInterval(timerInterval);
    startBtn.disabled = false;
    pauseBtn.disabled = true;
    resetBtn.disabled = true;
    remainingSeconds = 0;
    updateTimerDisplay();
  }
  
  // Timer complete
  function timerComplete() {
    // Visual notification
    timerDisplay.classList.add('text-danger');
    setTimeout(() => timerDisplay.classList.remove('text-danger'), 3000);
    
    // Sound notification
    if (soundNotificationCheckbox.checked) {
      try {
        notificationSound = createNotificationSound();
        notificationSound.play();
      } catch (error) {
        console.error('Error playing notification sound:', error);
      }
    }
    
    // Vibration notification
    if (vibrationNotificationCheckbox.checked && 'vibrate' in navigator) {
      try {
        navigator.vibrate([300, 100, 300, 100, 300]);
      } catch (error) {
        console.error('Error triggering vibration:', error);
      }
    }
    
    // Reset controls
    startBtn.disabled = true;
    pauseBtn.disabled = true;
    resetBtn.disabled = false;
  }
  
  // Set custom time
  function setCustomTime() {
    const minutes = parseInt(minutesInput.value) || 0;
    const seconds = parseInt(secondsInput.value) || 0;
    remainingSeconds = (minutes * 60) + seconds;
    
    if (remainingSeconds > 0) {
      updateTimerDisplay();
      startBtn.disabled = false;
      resetBtn.disabled = false;
    } else {
      resetTimer();
    }
  }
  
  // Load saved timers
  function loadSavedTimers() {
    fetch('/rest-timer-api/')
      .then(response => response.json())
      .then(data => {
        if (data.success && data.timers.length > 0) {
          noTimersMessage.style.display = 'none';
          savedTimersList.innerHTML = '';
          
          data.timers.forEach(timer => {
            const timerCard = document.createElement('div');
            timerCard.className = 'card timer-card';
            timerCard.innerHTML = `
              <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-0">${timer.name} ${timer.is_default ? '<span class="badge bg-primary">Default</span>' : ''}</h6>
                  <small class="text-muted">${formatTime(timer.duration)}</small>
                </div>
                <div class="timer-actions">
                  <button class="btn btn-sm btn-outline-primary use-timer" data-timer-id="${timer.id}" data-timer-duration="${timer.duration}">
                    <i class="fas fa-play"></i> Use
                  </button>
                  <button class="btn btn-sm btn-outline-secondary edit-timer" data-timer-id="${timer.id}" data-timer-name="${timer.name}" data-timer-duration="${timer.duration}" data-timer-default="${timer.is_default}">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-danger delete-timer" data-timer-id="${timer.id}">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            `;
            savedTimersList.appendChild(timerCard);
          });
          
          // Add event listeners to the newly created buttons
          document.querySelectorAll('.use-timer').forEach(btn => {
            btn.addEventListener('click', function() {
              remainingSeconds = parseInt(this.dataset.timerDuration);
              updateTimerDisplay();
              startBtn.disabled = false;
              resetBtn.disabled = false;
            });
          });
          
          document.querySelectorAll('.edit-timer').forEach(btn => {
            btn.addEventListener('click', function() {
              document.getElementById('editTimerId').value = this.dataset.timerId;
              document.getElementById('editTimerName').value = this.dataset.timerName;
              document.getElementById('editTimerDuration').value = this.dataset.timerDuration;
              document.getElementById('editSetAsDefault').checked = this.dataset.timerDefault === 'true';
              
              const editModal = new bootstrap.Modal(document.getElementById('editTimerModal'));
              editModal.show();
            });
          });
          
          document.querySelectorAll('.delete-timer').forEach(btn => {
            btn.addEventListener('click', function() {
              document.getElementById('deleteTimerId').value = this.dataset.timerId;
              
              const deleteModal = new bootstrap.Modal(document.getElementById('deleteTimerModal'));
              deleteModal.show();
            });
          });
        } else {
          noTimersMessage.style.display = 'block';
        }
      })
      .catch(error => {
        console.error('Error loading saved timers:', error);
      });
  }
  
  // Save a new timer
  function saveTimer() {
    const name = document.getElementById('timerName').value.trim();
    const duration = parseInt(document.getElementById('timerDuration').value);
    const isDefault = document.getElementById('setAsDefault').checked;
    
    if (!name || duration <= 0) {
      alert('Please enter a valid name and duration.');
      return;
    }
    
    const data = {
      name: name,
      duration: duration,
      is_default: isDefault
    };
    
    fetch('/rest-timer-api/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      },
      body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const modal = bootstrap.Modal.getInstance(document.getElementById('saveTimerModal'));
        modal.hide();
        
        // Reset form
        document.getElementById('timerName').value = '';
        document.getElementById('timerDuration').value = '60';
        document.getElementById('setAsDefault').checked = false;
        
        // Reload timers
        loadSavedTimers();
      } else {
        alert('Error saving timer: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Error saving timer:', error);
      alert('An error occurred while saving the timer.');
    });
  }
  
  // Update an existing timer
  function updateTimer() {
    const id = document.getElementById('editTimerId').value;
    const name = document.getElementById('editTimerName').value.trim();
    const duration = parseInt(document.getElementById('editTimerDuration').value);
    const isDefault = document.getElementById('editSetAsDefault').checked;
    
    if (!name || duration <= 0) {
      alert('Please enter a valid name and duration.');
      return;
    }
    
    const data = {
      name: name,
      duration: duration,
      is_default: isDefault
    };
    
    fetch(`/rest-timer-api/${id}/`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      },
      body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const modal = bootstrap.Modal.getInstance(document.getElementById('editTimerModal'));
        modal.hide();
        
        // Reload timers
        loadSavedTimers();
      } else {
        alert('Error updating timer: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Error updating timer:', error);
      alert('An error occurred while updating the timer.');
    });
  }
  
  // Delete a timer
  function deleteTimer() {
    const id = document.getElementById('deleteTimerId').value;
    
    fetch(`/rest-timer-api/${id}/`, {
      method: 'DELETE',
      headers: {
        'X-CSRFToken': getCSRFToken()
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteTimerModal'));
        modal.hide();
        
        // Reload timers
        loadSavedTimers();
      } else {
        alert('Error deleting timer: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Error deleting timer:', error);
      alert('An error occurred while deleting the timer.');
    });
  }
  
  // Event listeners
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize timer display
    updateTimerDisplay();
    
    // Load saved timers
    loadSavedTimers();
    
    // Timer control buttons
    startBtn.addEventListener('click', startTimer);
    pauseBtn.addEventListener('click', pauseTimer);
    resetBtn.addEventListener('click', resetTimer);
    setCustomTimeBtn.addEventListener('click', setCustomTime);
    
    // Preset buttons
    document.querySelectorAll('.timer-preset').forEach(btn => {
      btn.addEventListener('click', function() {
        remainingSeconds = parseInt(this.dataset.seconds);
        updateTimerDisplay();
        startBtn.disabled = false;
        resetBtn.disabled = false;
      });
    });
    
    // Save timer button
    document.getElementById('saveTimerBtn').addEventListener('click', saveTimer);
    
    // Update timer button
    document.getElementById('updateTimerBtn').addEventListener('click', updateTimer);
    
    // Delete timer button
    document.getElementById('confirmDeleteBtn').addEventListener('click', deleteTimer);
  });
</script>
{% endblock %}